{% extends 'base.html.twig' %}

{% block title %}{{ parent() }} | Activités {% endblock %}

{% block js %}

    <!-- Fichiers Javascript -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>

    <script>
        const selectCity = document.getElementById('activity_city');
        const selectLocation = document.getElementById('activity_location');
        const divLocationDetail = document.getElementById('location_detail');

        let macarte = null;
        // Fonction d'initialisation de la carte
        function initMap(lat, lon) {
            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView([lat, lon], 11);
            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                minZoom: 1,
                maxZoom: 20
            }).addTo(macarte);
        }

        selectCity.addEventListener('change', function(element) {
            let cityId = selectCity.value;

            if (cityId != null)
            {
                function createNode(element) {
                    return document.createElement(element);
                }

            function append(parent, el) {
                return parent.appendChild(el);
            }

            const url = `http://localhost/sortir/public/api/location/city/${cityId}`;

            fetch(url)
                .then((resp) => resp.json())
                .then(function (resp) {
                    let locations = resp;
                    console.log(selectLocation)
                    console.log(locations)
                    selectLocation.innerHTML = ''
                    let placeHolder = createNode('option');
                    placeHolder.innerHTML = '-Veuillez choisir un lieu-'
                    append(selectLocation, placeHolder);
                    return locations.map(function (location) {
                        let newOption = createNode('option');
                        newOption.innerHTML = location.name
                        newOption.value = location.id
                        append(selectLocation, newOption);
                    })
                })
                .catch(function (error) {
                    console.log(error);
                });
            }
        })

        selectLocation.addEventListener('change', function () {
            let locationId = selectLocation.value;
            let lat = 48.852969;
            let lon = 2.349903;
            if (locationId != null)
            {
                function createNode(element) {
                    return document.createElement(element);
                }

                function append(parent, el) {
                    return parent.appendChild(el);
                }

                const url2 = `http://localhost/sortir/public/api/location/${locationId}`;

                fetch(url2)
                    .then((resp2) => resp2.json())
                    .then(function (resp2) {
                        let locationDetails = resp2;
                        console.log(divLocationDetail)
                        console.log(locationDetails)
                        divLocationDetail.innerHTML = ""
                            let pStreet = createNode('p');
                            let pLongitude = createNode('p');
                            let pLatitude = createNode('p');
                            // pStreet.innerHTML = location.street
                            pStreet.innerHTML = 'Rue : ' + locationDetails.street + '<br>'
                            pLongitude.innerHTML = 'Longitude : ' + locationDetails.longitude + '<br>'
                            pLatitude.innerHTML = 'Latitude : ' + locationDetails.latitude + '<br>'

                            append(divLocationDetail, pStreet);
                            append(divLocationDetail, pLongitude);
                            append(divLocationDetail, pLatitude);
                            lat = locationDetails.latitude;
                            lon = locationDetails.longitude;

                            let divMap = document.getElementById('map')
                            divMap.innerHTML = ''

                            initMap(lat, lon)

                        })

                    .catch(function (error) {
                        console.log(error);
                    });

            }
        })

    </script>


{#    <script type="text/javascript">#}
{#        // On initialise la latitude et la longitude de Paris (centre de la carte)#}
    {#    let lat = 48.852969;#}
    {#    let lon = 2.349903;#}
    {#    let macarte = null;#}
    {#    // Fonction d'initialisation de la carte#}
    {#    function initMap() {#}
    {#        // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"#}
    {#        macarte = L.map('map').setView([lat, lon], 11);#}
    {#        // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr#}
    {#        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {#}
    {#            // Il est toujours bien de laisser le lien vers la source des données#}
    {#            attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',#}
    {#            minZoom: 1,#}
    {#            maxZoom: 20#}
    {#        }).addTo(macarte);#}
    {#    }#}
    {#    window.onload = function(){#}
    {#        // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé#}
    {#        initMap();#}
    {#    };#}
    {#</script>#}

{% endblock %}

{% block body %}
    <h2>
        {% if activity.id == null %}
            Créer une sortie
            {% else %}
            Modifier une sortie
        {% endif %}
    </h2>
    {{ form_start(activityForm) }}

    <div class="form">

        <div>{{ form_row(activityForm.name) }}</div>
        <div>{{ form_row(activityForm.startingDateTime) }}</div>
        <div>{{ form_row(activityForm.registrationDeadLine) }}</div>
        <div>{{ form_row(activityForm.maxRegistrationNb) }}</div>
        <div>{{ form_row(activityForm.duration) }}</div>
        <div>{{ form_row(activityForm.overview) }}</div>
        <div>{{ form_row((activityForm.campus)) }}</div>
        <div>{{ form_row((activityForm.city)) }}</div>

        <div>
            <label for="activity_location">Lieu : </label>
            <select id="activity_location"></select>
        </div>

        <div id="location_detail"></div>

        <div>
            <a class="" href="
            {% if activity.id == null %}
                {{ path('location_add') }}
            {% else %}
                {{ path('location_update_add', {'id': activity.id}) }}
            {% endif %}
            " onclick="return confirm('Voulez-vous ajouter un nouveau lieu ?')">Ajouter un lieu</a>
        </div>

        <a href="{{ path('activity_home') }}">Annuler</a>

        <div>

            {% if activity.id != null %}

                <a class="" href="{{ path('activity_remove', {'id': activity.id})}}"
                   onclick="return confirm('Etes-vous sûr de de vouloir supprimer cette sortie ?')">Supprimer cette sortie</a>

            {% endif %}
        </div>
    </div>

    {{ form_end(activityForm) }}

    <div id="map">
        <!-- Ici s'affichera la carte -->
    </div>

{% endblock %}